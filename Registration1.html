<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>International Registration Form</title>
  <style>
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; gap: 20px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
    .hd { font-size: 1.5em; font-weight: bold; margin-bottom: 16px; }
    .bd { font-size: 1em; }
    .fee-grid { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
    .muted { color: #666; font-size: 0.9em; }
    .total { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    .amt { font-size: 1.2em; color: #2c3e50; }
    select, input[type="number"], input[type="text"], input[type="email"], input[type="tel"] { 
      padding: 8px; font-size: 1em; border: 1px solid #ddd; border-radius: 4px; width: 100%; 
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .row.single { grid-template-columns: 1fr; }
    .success { display: none; color: green; margin-bottom: 16px; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    .btn.primary { background: #007bff; color: white; }
    .btn:hover { opacity: 0.9; }
    @media (max-width: 600px) {
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="grid">
      <!-- Fees & Add-ons -->
      <section class="card" id="fees">
        <div class="hd">Registration Fees & Add-ons</div>
        <div class="bd">
          <div class="fee-grid">
            <div>
              <label for="status">Registration Category</label>
            </div>
            <div>
              <!-- UI-only selector (not posted to Google) -->
              <select id="status" aria-label="Select registration category">
                <option value="nonmember">Non-member (NT$20,000 ≈USD$645)</option>
                <option value="member">ISPH Member (NT$18,000 ≈USD$581)</option>
                <option value="student">Student (NT$10,000 ≈USD$323)</option>
                <option value="reduced">Reduced Registration (NT$10,000 ≈USD$323)</option>
              </select>
            </div>
          </div>

          <div class="fee-grid" style="margin-top:12px">
            <div>
              <label>Accompanying Person <span class="muted">(NT$3,300 ≈USD$106 per person)</span></label>
            </div>
            <div>
              <input type="number" id="qtyCompanion" name="entry.2073761257" min="0" value="0" aria-label="Number of accompanying persons" />
            </div>
          </div>

          <div class="fee-grid" style="margin-top:12px">
            <div>
              <label>Welcome Dinner <span class="muted">(NT$3,300 ≈USD$106 per person)</span></label>
            </div>
            <div>
              <input type="number" id="qtyBanquet" name="entry.566557431" min="0" value="0" aria-label="Number of welcome dinner tickets" />
            </div>
          </div>

          <div class="fee-grid" style="margin-top:12px">
            <div>
              <label>Half-Day Conference Tour <span class="muted">(NT$2,500 ≈USD$81 per person)</span></label>
            </div>
            <div>
              <input type="number" id="qtyTour" name="entry.932349988" min="0" value="0" aria-label="Number of conference tour tickets" />
            </div>
          </div>

          <div class="total" aria-live="polite" style="margin-top:16px">
            <div>
              <div>Total Amount</div>
              <div class="muted">Automatically updated based on selections</div>
            </div>
            <div class="amt" id="amount">NT$10,000 (≈USD$323)</div>
          </div>
        </div>
      </section>

      <!-- Registration Form (Google Forms) -->
      <section class="card" id="register">
        <div class="hd">Online Registration Form</div>
        <div class="bd">
          <!-- IMPORTANT: Action points to Google Forms formResponse endpoint -->
          <form id="regForm" action="https://docs.google.com/forms/d/e/1FAIpQLSf12TU9hAyHa-nquchyXXml4QDIB9Jj83oeod6CSrWuHNQ6zg/formResponse" method="POST" target="hidden_iframe" novalidate>
            <div id="okMsg" class="success">✅ Registration submitted! We have received your information, and a confirmation email will be sent to you.</div>

            <div class="row single">
              <div>
                <label>Full Name <span style="color:red">* (First name then family name)</span></label>
                <input type="text" name="entry.1195663187" required placeholder="e.g., John Smith" />
              </div>
            </div>
            <div class="row single">
              <div>
                <label>Email <span style="color:red">*</span></label>
                <input type="email" name="entry.1329980034" required placeholder="e.g., john.smith@example.com" />
                <!-- Hidden emailAddress for Google 'send copy to respondent' feature -->
                <input type="hidden" id="emailAddressHidden" name="emailAddress" value="" />
              </div>
            </div>
            <div class="row single">
              <div>
                <label>Phone Number <span style="color:red">*</span></label>
                <input type="tel" name="entry.1504094709" required placeholder="e.g., +886-9xx-xxx-xxx" />
              </div>
            </div>
            <div class="row single">
              <div>
                <label>Title <span style="color:red">*</span></label>
                <!-- Google field: entry.252943400 (e.g., Dr) -->
                <input type="text" name="entry.252943400" required placeholder="e.g., Dr." />
              </div>
            </div>
            <div class="row single">
              <div>
                <label>Affiliation</label>
                <!-- Google field: entry.1165126282 (organization) -->
                <input type="text" name="entry.1165126282" placeholder="e.g., XX University" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Registration Category <span style="color:red">*</span></label>
                <!-- Google field: entry.573453040 (value must match Google option text) -->
                <select id="formStatus" name="entry.573453040" required>
                  <option value="">Please select</option>
                  <!-- Values set to EXACT Chinese option texts used in the Google Form -->
                  <option value="非會員（NT$ 20,000）">Non-member (NT$20,000 ≈USD$645)</option>
                  <option value="會員（NT$ 18,000）">ISPH Member (NT$18,000 ≈USD$581)</option>
                  <option value="學生（NT$ 10,000）">Student (NT$10,000 ≈USD$323)</option>
                  <option value="優惠註冊（NT$ 10,000）">Reduced Registration (NT$10,000 ≈USD$323)</option>
                </select>
              </div>
              <div>
                <label>Dietary Requirements <span style="color:red">*</span></label>
                <!-- Google field: entry.78350209 -->
                <select name="entry.78350209" required>
                  <option value="葷食">No restrictions</option>
                  <option value="素食">Vegetarian</option>
                  <option value="特殊過敏（請於備註欄說明）">Special requirements (please specify in remarks)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Invoice/Receipt Requirement <span style="color:red">*</span></label>
                <!-- Google field: entry.1845447127 -->
                <select name="entry.1845447127" required>
                  <option value="不需要">Not required</option>
                  <option value="收據（個人）">Personal receipt</option>
                  <option value="發票（公司）">Company invoice</option>
                </select>
              </div>
              <div>
                <label>Payment Method <span style="color:red">*</span></label>
                <!-- Google field: entry.1154667495 -->
                <select name="entry.1154667495" required>
                  <option value="銀行轉帳">Bank transfer</option>
                  <option value="現場繳費">On-site payment</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Invoice/Receipt Title</label>
                <input type="text" name="entry.179378040" placeholder="e.g., XYZ Corporation / John Smith" />
              </div>
              <div>
                <label>Tax ID (for company invoice)</label>
                <input type="text" name="entry.984856977" placeholder="e.g., 12345678" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Mailing Address</label>
                <input type="text" name="entry.1261185884" placeholder="Address for sending invoice/receipt" />
              </div>
              <div>
                <label>Remarks</label>
                <input type="text" name="entry.749605536" placeholder="e.g., Specify any allergies" />
              </div>
            </div>

            <!-- Additional Purchase Quantities -->
            <div class="row">
              <div>
                <label>Accompanying Person Quantity</label>
                <input type="number" id="postCompanion" name="entry.2073761257" min="0" value="0" />
              </div>
              <div>
                <label>Welcome Dinner Quantity</label>
                <input type="number" id="postBanquet" name="entry.566557431" min="0" value="0" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>Half-Day Conference Tour Quantity</label>
                <input type="number" id="postTour" name="entry.932349988" min="0" value="0" />
              </div>
              <div>
                <label>Total Amount (Auto-calculated, Display Only)</label>
                <input type="text" id="postTotal" readonly />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Data Consent <span style="color:red">*</span></label>
                <label style="display:flex;gap:8px;align-items:center">
                  <!-- Google field: entry.979619625 MUST match exact consent text -->
                  <input type="checkbox" id="gdpr" name="entry.979619625" value="我同意本會為活動聯繫與保險用途使用聯絡資訊" required />
                  <span>I consent to the use of my contact information for event-related purposes</span>
                </label>
              </div>
            </div>

            <div class="total" aria-live="polite">
              <div>
                <div>Total Amount</div>
                <div class="muted">Payment details will be sent to your email upon submission</div>
              </div>
              <div class="amt" id="amountBottom">NT$10,000 (≈USD$323)</div>
            </div>

            <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
              <button type="submit" class="btn primary">Submit Registration</button>
              <button type="reset" class="btn" id="resetBtn">Clear</button>
            </div>
          </form>
          <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
        </div>
      </section>

      <section class="card" id="faq" style="margin-top:22px">
        <div class="hd">Important Notes</div>
        <div class="bd">
          <ol class="muted">
            <li>Upon successful registration, a confirmation email will be sent to your email address.</li>
            <li>Payment Information: Please complete the bank transfer within <span style="color: red;">3 days</span> after submitting the form (Bank details: Chang Hwa Bank, North Taichung Branch (009), Account: 4004 51 48739 300, Account Holder: Jin-Kun Wang).</li>
            <li>Refund Policy: Full refund (less processing fee) if canceled 14 days or more before the event; 50% refund if canceled 7–13 days before; no refunds within 6 days, but participant substitution is allowed.</li>
            <li>Receipt: A temporary receipt will be provided on-site. For an official receipt, please register on-site, and it will be mailed within 30 working days after the event.</li>
          </ol>
        </div>
      </section>
    </div>
  </main>

  <script>
    const FEES = { 
      companion: 3300, 
      banquet: 3300, 
      tour: 2500 
    };
    const USD_RATE = 31;
    const fmt = (n) => `NT$${n.toLocaleString('en-US')} (≈USD$${Math.round(n / USD_RATE)})`;

    const statusSelect = document.getElementById('status');
    const formStatus = document.getElementById('formStatus');
    const qtyCompanion = document.getElementById('qtyCompanion');
    const qtyBanquet = document.getElementById('qtyBanquet');
    const qtyTour = document.getElementById('qtyTour');
    const postCompanion = document.getElementById('postCompanion');
    const postBanquet = document.getElementById('postBanquet');
    const postTour = document.getElementById('postTour');
    const amountTop = document.getElementById('amount');
    const amountBottom = document.getElementById('amountBottom');
    const postTotal = document.getElementById('postTotal');

    // Mapping from UI status to base fee
    function getNum(el) { return Math.max(0, parseInt(el?.value || '0', 10) || 0); }

    function calc() {
      const status = statusSelect?.value || 'student';
      const baseFee = status === 'nonmember' ? 20000 : status === 'member' ? 18000 : 10000;
      const c = getNum(qtyCompanion);
      const b = getNum(qtyBanquet);
      const t = getNum(qtyTour);
      const total = baseFee + c * FEES.companion + b * FEES.banquet + t * FEES.tour;
      if (amountTop) amountTop.textContent = fmt(total);
      if (amountBottom) amountBottom.textContent = fmt(total);
      if (postTotal) postTotal.value = total;
      // Sync form quantities
      if (postCompanion) postCompanion.value = c;
      if (postBanquet) postBanquet.value = b;
      if (postTour) postTour.value = t;
      // Sync form status to Google-expected Chinese option text
      if (formStatus) {
        formStatus.value = {
          'nonmember': '非會員（NT$ 20,000）',
          'member': '會員（NT$ 18,000）',
          'student': '學生（NT$ 10,000）',
          'reduced': '優惠註冊（NT$ 10,000）'
        }[status] || '';
      }
    }

    function syncQuantitiesFromForm() {
      if (qtyCompanion) qtyCompanion.value = getNum(postCompanion);
      if (qtyBanquet) qtyBanquet.value = getNum(postBanquet);
      if (qtyTour) qtyTour.value = getNum(postTour);
      calc();
    }

    function syncStatusFromForm() {
      if (formStatus && statusSelect) {
        const mapping = {
          '非會員（NT$ 20,000）': 'nonmember',
          '會員（NT$ 18,000）': 'member',
          '學生（NT$ 10,000）': 'student',
          '優惠註冊（NT$ 10,000）': 'reduced'
        };
        statusSelect.value = mapping[formStatus.value] || 'student';
        calc();
      }
    }

    [statusSelect, qtyCompanion, qtyBanquet, qtyTour].forEach(el => {
      el?.addEventListener('input', calc);
      el?.addEventListener('change', calc);
    });

    [postCompanion, postBanquet, postTour].forEach(el => {
      el?.addEventListener('input', syncQuantitiesFromForm);
      el?.addEventListener('change', syncQuantitiesFromForm);
    });

    formStatus?.addEventListener('change', syncStatusFromForm);

    calc();

    // Google Forms Submission
    const regForm = document.getElementById('regForm');
    const okMsg = document.getElementById('okMsg');
    const resetBtn = document.getElementById('resetBtn');
    const emailInput = regForm?.querySelector('input[name="entry.1329980034"]');
    const emailHidden = document.getElementById('emailAddressHidden');
    let submitted = false;

    regForm.addEventListener('submit', (e) => {
      if (!regForm.reportValidity()) { e.preventDefault(); return; }
      if (emailHidden && emailInput) { emailHidden.value = emailInput.value || ''; }
      submitted = true;
      if (okMsg) { okMsg.style.display = 'block'; okMsg.textContent = '⌛ Submitting… Please wait'; }
    });

    document.getElementById('hidden_iframe').addEventListener('load', () => {
      if (!submitted) return;
      if (okMsg) { okMsg.style.display = 'block'; okMsg.textContent = '✅ Registration submitted! We have received your information, and a confirmation email will be sent to you.'; }
      regForm.reset();
      ['qtyCompanion', 'qtyBanquet', 'qtyTour', 'postCompanion', 'postBanquet', 'postTour'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = 0;
      });
      const statusSelect = document.getElementById('status');
      if (statusSelect) statusSelect.value = 'student';
      if (formStatus) formStatus.value = '';
      calc();
      submitted = false;
    });

    resetBtn.addEventListener('click', () => { setTimeout(calc, 0); });
  </script>
</body>
</html>
